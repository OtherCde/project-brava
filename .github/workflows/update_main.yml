name: Update Repository & Deploy Changes

on:
    pull_request:
      branches: [main]
      types: [closed]
    workflow_dispatch:

jobs:
  update-repo:
    runs-on: ubuntu-latest

    steps:
      - name: Configurar SSH
        run: |
          echo "ğŸ”¹ Creando la clave privada..." 
          echo "${{ secrets.SSH_MAIN }}" > private_key
          chmod 600 private_key 
          
          eval "$(ssh-agent -s)"
          echo "${{ secrets.SSH_PASSPHRASE }}" | ssh-add private_key
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

          echo "âœ… ConfiguraciÃ³n SSH completada"

      - name: Actualizar repositorio
        run: |

          echo "ğŸ”¹ Verificando existencia de private_key..."
          ls -l private_key || echo "âš ï¸ ERROR: private_key no encontrado"
          
          echo "ğŸ”¹ Iniciando ssh-agent..."
          eval "$(ssh-agent -s)"
          
          echo "ğŸ”¹ Agregando clave privada al ssh-agent con passphrase..."
          echo "${{ secrets.SSH_PASSPHRASE }}" | ssh-add private_key 
          
          echo "ğŸ”¹ Conectando al servidor y ejecutando despliegue..."

          ssh -T -i private_key brava-ssh@64.227.97.181 << 'DEPLOY_EOF'
            set -e
            cd htdocs/brava.okarol.com

            # Crear .env usando variables del entorno
            cat > .env << ENV_EOF
            SECRET_KEY='$SECRET_KEY'
            DB_NAME='$DB_NAME'
            DB_USER='$DB_USER'
            DB_PASSWORD='$DB_PASSWORD'
            DB_HOST='$DB_HOST'
            DB_PORT='$DB_PORT'
            GOOGLE_CLIENT_ID='$GOOGLE_CLIENT_ID'
            GOOGLE_CLIENT_SECRET='$GOOGLE_CLIENT_SECRET'
            FACEBOOK_APP_ID='$FACEBOOK_APP_ID'
            FACEBOOK_APP_SECRET='$FACEBOOK_APP_SECRET'
            FACEBOOK_REDIRECT_URI='$FACEBOOK_REDIRECT_URI'
            ENV_EOF

            git pull origin main
            source env-brav/bin/activate
            pip install -r requirements.txt
            python manage.py migrate

            echo "âœ… ActualizaciÃ³n completada"
          DEPLOY_EOF
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_SECRET }}
          FACEBOOK_APP_ID: ${{ secrets.FACEBOOK_ID }}
          FACEBOOK_APP_SECRET: ${{ secrets.FACEBOOK_SECRET }}
          FACEBOOK_REDIRECT_URI: ${{ secrets.FACEBOOK_REDIRECT }}